<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('fortuneWheel');
    const ctx = canvas?.getContext('2d');
    const spinButton = document.getElementById('spinButton');
    const resultDisplay = document.getElementById('resultDisplay');
    const appContainer = document.getElementById('app-container');
    const spinSound = document.getElementById('spinSound');
    const endSound = document.getElementById('endSound');

    if (!canvas || !ctx || !spinButton || !resultDisplay || !appContainer) {
        console.error("Un ou plusieurs éléments HTML requis sont manquants.");
        return;
    }

    const segments = [
        { text: "3 wins", value: 3, color: "#2f855a", url: "https://winstream.fr/addwinv2.php?win=3&token=invisikills_IngencyLive_1qh0v8bSg4Knr7gfBvHsGRDv1qOLMX" },
        { text: "-3 wins", value: -3, color: "#e53e3e", url: "https://winstream.fr/removewinv2.php?win=3&token=invisikills_IngencyLive_1qh0v8bSg4Knr7gfBvHsGRDv1qOLMX" },
        { text: "2 wins", value: 2, color: "#38a169", url: "https://winstream.fr/addwinv2.php?win=2&token=invisikills_IngencyLive_1qh0v8bSg4Knr7gfBvHsGRDv1qOLMX" },
        { text: "-2 wins", value: -2, color: "#dd6b20", url: "https://winstream.fr/removewinv2.php?win=2&token=invisikills_IngencyLive_1qh0v8bSg4Knr7gfBvHsGRDv1qOLMX" },
        { text: "1 win", value: 1, color: "#48bb78", url: "https://winstream.fr/addwinv2.php?win=1&token=invisikills_IngencyLive_1qh0v8bSg4Knr7gfBvHsGRDv1qOLMX" },
        { text: "-1 win", value: -1, color: "#ecc94b", url: "https://winstream.fr/removewinv2.php?win=1&token=invisikills_IngencyLive_1qh0v8bSg4Knr7gfBvHsGRDv1qOLMX" }
    ];
    const numSegments = segments.length;
    const arc = (2 * Math.PI) / numSegments;
    let currentRotation = 0;
    let spinSpeed = 0;
    const friction = 0.99;
    let isSpinning = false;

    function drawWheel() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) * 0.9;
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(currentRotation);
        for (let i = 0; i < numSegments; i++) {
            const angle = i * arc;
            const segment = segments[i];
            ctx.beginPath();
            ctx.arc(0, 0, radius, angle, angle + arc);
            ctx.lineTo(0, 0);
            ctx.closePath();
            ctx.fillStyle = segment.color;
            ctx.fill();
            ctx.strokeStyle = "#1a202c";
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.save();
            ctx.rotate(angle + arc / 2 + Math.PI / 2);
            ctx.fillStyle = "#e2e8f0";
            ctx.font = "bold 24px Inter";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(segment.text, 0, -radius * 0.6);
            ctx.restore();
        }
        ctx.restore();
    }

    async function callWinStreamAPI(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            await response.text();
        } catch (e) {
            console.error("Erreur WinStream API:", e);
        }
    }

    function animateSpin() {
        if (!isSpinning) return;
        currentRotation += spinSpeed;
        spinSpeed *= friction;
        if (spinSpeed < 0.001) {
            isSpinning = false;
            spinButton.disabled = false;
            spinButton.textContent = "Faire tourner la roue !";
            const normalizedRotation = (currentRotation % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
            let angleUnderPointer = (3 * Math.PI / 2 - normalizedRotation);
            angleUnderPointer = (angleUnderPointer % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
            const segmentIndex = Math.floor(angleUnderPointer / arc);
            const resultSegment = segments[segmentIndex];
            const messagePrefix = resultSegment.value < 0 ? "Vous avez perdu : " : "Vous avez gagné : ";
            resultDisplay.textContent = `${messagePrefix}${resultSegment.text} !`;
            resultDisplay.className = `text-2xl font-semibold text-center result-display ${resultSegment.value > 0 ? 'text-green-400' : 'text-red-400'}`;
            callWinStreamAPI(resultSegment.url);
            endSound?.play();
            setTimeout(() => {
                appContainer.classList.add('hidden-app');
                resultDisplay.textContent = "Prêt à jouer ?";
                resultDisplay.className = "text-2xl font-semibold text-center result-display";
            }, 5000);
        }
        drawWheel();
        requestAnimationFrame(animateSpin);
    }

    function initiateSpinAndShow() {
        appContainer.classList.remove('hidden-app');
        requestAnimationFrame(() => {
            resizeCanvas();
            spinWheel();
        });
    }

    function resizeCanvas() {
        const containerWidth = canvas.parentElement.clientWidth;
        const size = Math.min(containerWidth * 0.9, 400);
        canvas.width = size;
        canvas.height = size;
        drawWheel();
    }

    function spinWheel() {
        if (isSpinning) return;
        isSpinning = true;
        spinButton.disabled = true;
        spinButton.textContent = "La roue tourne...";
        resultDisplay.textContent = "En attente du résultat...";
        resultDisplay.className = "text-2xl font-semibold text-center result-display";
        spinSpeed = Math.random() * 0.1 + 0.05;
        currentRotation = 0;
        const randomSpins = Math.floor(Math.random() * 5) + 10;
        const targetSegmentIndex = Math.floor(Math.random() * numSegments);
        const targetSegmentCenterAngle = (targetSegmentIndex * arc) + (arc / 2);
        let finalStopAngle = (3 * Math.PI / 2) - targetSegmentCenterAngle;
        finalStopAngle = (finalStopAngle % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
        const totalRotation = randomSpins * 2 * Math.PI + finalStopAngle;

        const start = performance.now();
        const duration = 5000;
        const initialRotation = currentRotation;

        function smoothAnimation(now) {
            const elapsed = now - start;
            const progress = Math.min(elapsed / duration, 1);
            const easeOut = 1 - Math.pow(1 - progress, 3);
            currentRotation = initialRotation + easeOut * (totalRotation - initialRotation);
            drawWheel();
            if (progress < 1) {
                requestAnimationFrame(smoothAnimation);
            } else {
                isSpinning = false;
                spinButton.disabled = false;
                spinButton.textContent = "Faire tourner la roue !";
                const normalizedRotation = (currentRotation % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
                let angleUnderPointer = (3 * Math.PI / 2 - normalizedRotation);
                angleUnderPointer = (angleUnderPointer % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
                const segmentIndex = Math.floor(angleUnderPointer / arc);
                const resultSegment = segments[segmentIndex];
                const messagePrefix = resultSegment.value < 0 ? "Vous avez perdu : " : "Vous avez gagné : ";
                resultDisplay.textContent = `${messagePrefix}${resultSegment.text} !`;
                resultDisplay.className = `text-2xl font-semibold text-center result-display ${resultSegment.value > 0 ? 'text-green-400' : 'text-red-400'}`;
                callWinStreamAPI(resultSegment.url);
                endSound?.play();
                setTimeout(() => {
                    appContainer.classList.add('hidden-app');
                    resultDisplay.textContent = "Prêt à jouer ?";
                    resultDisplay.className = "text-2xl font-semibold text-center result-display";
                }, 5000);
            }
        }

        spinSound?.play();
        requestAnimationFrame(smoothAnimation);
    }

    drawWheel();
    spinButton.addEventListener('click', initiateSpinAndShow);
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('trigger') === '1') {
        initiateSpinAndShow();
    }
});
</script>
